{% extends "layout.html" %}

{% block style %}
<style>
    .a-post {
        margin-top: -1px;
        position: relative;
        border: 0.5px solid rgba(0, 0, 0, 0.3);
    }

    .a-post:hover {
        z-index: 1;
        border: 1px solid rgba(0, 0, 0, 0.7) !important;
        cursor: pointer;
    }


    #votebox {
        display: flex;
        flex-direction: column;
    }

    .upvote,
    .downvote {
        padding: 0;
        height: 20px;
        width: 20px;
        display: flex;
        align-items: center;
    }

    .upvote:hover,
    .downvote:hover {
        background: rgb(232, 232, 232);
    }

    .upvote-color {
        color: rgb(255, 69, 0) !important;
    }

    .downvote-color {
        color: rgb(113, 147, 255) !important;
    }

    .maxwidth-md {
        max-width: 55px;
    }

    @media screen and (max-width: 768px) {
        #votebox {
            flex-direction: row;
        }

        .maxwidth-md {
            max-width: none;
        }
    }

    .nav-link.active {
        color: rgb(0, 121, 211) !important;
        margin-bottom: -6px;
        border-bottom: 3px solid rgb(0, 121, 211) !important;
    }

    .nav-link:hover {
        color: rgb(0, 121, 211) !important;
    }

    .profile-link {
        text-decoration: none;
    }

    .profile-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block script %}
<script>
    $(document).ready(function () {

        $(".upvote").on("click", function (event) {
            event.stopPropagation();
            var id = $(event.currentTarget).prop("id");
            upvote(id);
        })

        $(".downvote").on("click", function (event) {
            event.stopPropagation();
            var id = $(event.currentTarget).prop("id");
            downvote(id);
        })

        $(".profile-link").on("click", function (event) {
            event.stopPropagation();
        })
    })

    function upvote(id) {
        $.ajax({
            type: "POST",
            url: "{{url_for('upvote')}}",
            contentType: "application/json; charset=UTF-8",
            dataType: "json",
            data: JSON.stringify({
                "type": "post",
                "id": id
            }),
            success: function (data) {
                if (data["status"] == "success") {
                    if (data["unvote"] == "false") {
                        upvotePost(data["id"], data);
                    } else {
                        renderNovotes(data["id"], data);
                    }
                } else {
                    alert("Sorry, something went wrong. Please refresh the page.");
                }
            },
            error: function (e) {
                console.log(e);
            }
        })
    }

    function downvote(id) {
        $.ajax({
            type: "POST",
            url: "{{url_for('downvote')}}",
            contentType: "application/json; charset=UTF-8",
            dataType: "json",
            data: JSON.stringify({
                "type": "post",
                "id": id
            }),
            success: function (data) {
                if (data["status"] == "success") {
                    if (data["unvote"] == "false") {
                        downvotePost(data["id"], data);
                    } else {
                        renderNovotes(data["id"], data);
                    }
                } else {
                    alert("Sorry, something went wrong. Please refresh the page.");
                }
            },
            error: function (e) {
                console.log(e);
            }
        })
    }

    function upvotePost(id, data) {
        $("#downvote-".concat(id).concat(" ,", "#icon-" + id)).removeClass("downvote-color");
        $("#upvote-".concat(id).concat(" ,", "#icon-" + id)).addClass("upvote-color");
        $("#icon-" + id).text(data["votes"]);
    }

    function downvotePost(id, data) {
        $("#upvote-".concat(id).concat(" ,", "#icon-" + id)).removeClass("upvote-color");
        $("#downvote-".concat(id).concat(" ,", "#icon-" + id)).addClass("downvote-color");
        $("#icon-" + id).text(data["votes"]);
    }

    function renderNovotes(id, data) {
        $("#downvote-".concat(id).concat(" ,", "#icon-" + id)).removeClass("downvote-color");
        $("#upvote-".concat(id).concat(" ,", "#icon-" + id)).removeClass("upvote-color");
        $("#icon-" + id).text(data["votes"]);
    }
</script>
{% endblock %}

{% block profilenavbar %}
<nav class="navbar navbar-expand navbar-light bg-white border-bottom py-0">
    <div class="container">
        <div class="navbar-nav py-1" style="font-size: 14px;">
            <a class="nav-link" href="{{url_for('profile', user=user)}}">OVERVIEW</a>
            <a class="nav-link active" href="#">POSTS</a>
            <a class="nav-link" href="{{url_for('profile-comments', user=user)}}">COMMENTS</a>
        </div>
    </div>
</nav>
{% endblock %}

{% block main %}

<div>
    {% for post in posts %}
    <div class="bg-white p-2 a-post" onclick="window.location = `{{url_for('post', id=post['post_id'])}}`">
        <div class="row">
            <div class="d-flex justify-content-center maxwidth-md">
                <div class="col col-md-12 order-last order-md-first">
                    <div id="votebox" class="d-flex align-items-center">
                        {% if post["vote"] == -1 %}
                        <div>
                            <button id="upvote-{{post['post_id']}}" class="upvote btn btn-sm mx-1">
                                <i class="fas fa-caret-up fa-2x"></i>
                            </button>
                        </div>
                        <div id="icon-{{post['post_id']}}" class="fw-bold downvote-color" style="font-size: 13px;">{{
                            post["votes"] }}</div>
                        <div>
                            <button id="downvote-{{post['post_id']}}" class="downvote btn btn-sm mx-1 downvote-color">
                                <i class="fas fa-caret-down fa-2x"></i>
                            </button>
                        </div>
                        {% elif post["vote"] == 1 %}
                        <div>
                            <button id="upvote-{{post['post_id']}}" class="upvote btn btn-sm mx-1 upvote-color">
                                <i class="fas fa-caret-up fa-2x"></i>
                            </button>
                        </div>
                        <div id="icon-{{post['post_id']}}" class="fw-bold upvote-color" style="font-size: 13px;">
                            {{ post["votes"] }}</div>
                        <div>
                            <button id="downvote-{{post['post_id']}}" class="downvote btn btn-sm mx-1">
                                <i class="fas fa-caret-down fa-2x"></i>
                            </button>
                        </div>
                        {% else %}
                        <div>
                            <button id="upvote-{{post['post_id']}}" class="upvote btn btn-sm mx-1">
                                <i class="fas fa-caret-up fa-2x"></i>
                            </button>
                        </div>
                        <div id="icon-{{post['post_id']}}" class="fw-bold" style="font-size: 13px;">{{ post["votes"] }}
                        </div>
                        <div>
                            <button id="downvote-{{post['post_id']}}" class="downvote btn btn-sm mx-1">
                                <i class="fas fa-caret-down fa-2x"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="col-12 col-md order-first order-md-last ps-3 ps-md-0">
                <div class="h5 text-break">
                    {{ post["title"] }}
                </div>
                <div class="text-muted" style="font-size: small">
                    Posted by <a class="profile-link text-muted" href="{{url_for('profile', user=user)}}">
                        {{ user }}</a> {{ moment(post["date"]).fromNow() }}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    <div class="m-4"></div>
</div>

{% if not posts %}
<div class="row nocomments">
    <div class="col-md-4"></div>
    <div class="col h3 fw-light text-break d-flex justify-content-center align-items-center" style="height: 400px;">
        @{{user}} hasn't posted anything
    </div>
    <div class="col-md-4"></div>
</div>
{% endif %}

{% endblock %}